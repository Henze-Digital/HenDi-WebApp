# GitLab CI configuration for the "HWH-WebApp"
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://localhost:2375
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

stages:
  - build-app
  - test
  - build-docker

build-webapp:
  image: ubuntu
  stage: build-app
  before_script:
    - apt-get update
    - apt-get upgrade -y
    - apt install -y --no-install-recommends ant
    - apt install nodejs -y
    - apt install npm -y
    - npm install --global yarn
    - yarn install
    - npm install -g sass
    - apt-get install git -y
    - apt-get install -y minify
  script:
    - ant ci -Dsass.path=`which sass` -Dminify.path=`which minify` -DCI_JOB_TOKEN=${CI_JOB_TOKEN}
  artifacts:
    paths:
      - webapp/HenDi-WebApp-*.xar

merge request artifact:
  image: ubuntu
  stage: build-app
  before_script:
    - apt-get update
    - apt-get upgrade -y
    - apt install -y --no-install-recommends ant
    - apt install nodejs -y
    - apt install npm -y
    - npm install --global yarn
    - yarn install
    - npm install -g sass
    - apt-get install git -y
    - apt-get install -y minify
  script:
    - ant ci -Dsass.path=`which sass` -Dminify.path=`which minify` -DCI_JOB_TOKEN=${CI_JOB_TOKEN}
  artifacts:
    paths:
      - webapp/HenDi-WebApp-*.xar
  only:
    - merge_requests
  #rules:
  #  - if: $CI_PIPELINE_SOURCE == 'merge_request_event'

build-docker:
   stage: build-docker
   image: docker:19.03.1
   services:
     - docker:19.03.1-dind
   needs: [build-webapp]
   script:
     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
     - docker build --network host -t $IMAGE_TAG .
     - docker push $IMAGE_TAG
   dependencies:
     - build-webapp
