<?xml version="1.0" encoding="UTF-8"?>
<project default="xar" name="HenDi-WebApp" basedir="." xmlns:unless="ant:unless">
	
	<dirname property="HenDi-WebApp.basedir" file="${ant.file.HenDi-WebApp}"/>
	
	<!-- import default properties from file -->
	<property file="${HenDi-WebApp.basedir}/local.build.properties" prefix="hendi"/>
	<property file="${HenDi-WebApp.basedir}/build.properties" prefix="hendi"/>
	
	<import file="WeGA-WebApp/build.xml" as="wega" prefixseparator=":"/>
	<property file="${WeGA-WebApp.basedir}/local.build.properties" prefix="wega"/>
	<property file="${WeGA-WebApp.basedir}/build.properties" prefix="wega"/>
	
	<target name="-set-properties" unless="${build.env}">
		<property name="sass.path" value="${WeGA-WebApp.basedir}/${wega.sass.cmd}"/>
		<property name="minify.path" value="${WeGA-WebApp.basedir}/${wega.dev_libs.dir}/minify/bin/minify.js"/>
	</target>
	
	<target name="get-hendi-secrets-for-ci" if="${build.env}">
		<echo>Clone HenDi-secrets</echo>
		<exec executable="git" dir="." failonerror="no">
			<arg line="clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.uni-paderborn.de/vife/henze-digital/hwh-data-internal-only.git hendi-secrets"/>
		</exec>
	</target>
	
	<target name="webapp-wega-prepare-tasks" depends="get-hendi-secrets-for-ci">
		<echo>Execute yarn, initalizes also WeGA-WebApp</echo>
		<antcall target="wega:yarn"/>
		<echo>Update SASS files with ${hendi.project.app} data</echo>
		<antcall target="hendi-sass-compilation"/>
		
		<echo>Prepare package files</echo>
		<antcall target="hendi-package-files"/>
		
		<echo>Get data for webapp build</echo>
		<antcall target="webapp-get-data"/>
	</target>
	
	<target name="hendi-sass-compilation" depends="-set-properties">
		<echo>Overwrite SASS files with HenDi data</echo>
		<copy todir="${WeGA-WebApp.basedir}/resources/sass" overwrite="yes">
			<fileset dir="data/resources/sass" includes="**"/>
		</copy>
		<echo>Add node_modules to ${WeGA-WebApp.basedir}</echo>
		<move todir="${WeGA-WebApp.basedir}/node_modules">
			<fileset dir="node_modules"/>
		</move>
		<echo>Create CSS files via sass</echo>
		<mkdir dir="${WeGA-WebApp.basedir}/resources/css"/>
		<exec executable="${sass.path}">
			<arg line="${WeGA-WebApp.basedir}/resources/sass/main.scss ${WeGA-WebApp.basedir}/resources/css/styles.css"/>
		</exec>
	</target>
	
	<target name="hendi-package-files">
		<echo>Create expath-pkg.xml</echo>
		<copy file="data/expath-pkg.xml.tmpl" tofile="${WeGA-WebApp.basedir}/${wega.dist.dir}/expath-pkg.xml" filtering="true" overwrite="true">
			<filterset>
				<filter token="project.app" value="${hendi.project.app}"/>
				<filter token="project.name" value="${hendi.project.name}"/>
				<filter token="project.version" value="${hendi.project.version}"/>
			</filterset>
		</copy>
		<echo>Create repo.xml</echo>
		<copy file="data/repo.xml.tmpl" tofile="${WeGA-WebApp.basedir}/${wega.dist.dir}/repo.xml" filtering="true" overwrite="true">
			<filterset>
				<filter token="project.app" value="${hendi.project.app}"/>
				<filter token="project.author" value="${hendi.project.author}"/>
				<filter token="project.name" value="${hendi.project.name}"/>
			</filterset>
		</copy>
	</target>
	
	<target name="webapp-get-data">
		<echo>Get data files from WeGA-WebApp dist task </echo>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}">
			<fileset dir="${WeGA-WebApp.basedir}">
				<include name="*.*"/>
				<include name="api/**"/>
				<include name="modules/**"/>
				<include name="resources/**"/>
				<include name="catalogues/**"/>
				<include name="indices/**"/>
				<include name="templates/**"/>
				<include name="xsl/**"/>
				<exclude name="build.xml"/>
				<exclude name="*build.properties"/>
				<exclude name=".git*"/>
				<exclude name="*.tmpl"/>
				<exclude name="*.txt"/>
				<exclude name="*.xpr"/>
				<exclude name="package.json"/>
				<exclude name="yarn.lock"/>
				<exclude name=".dockerignore"/>
				<exclude name=".travis.yml"/>
				<exclude name="**/less/**"/>
				<exclude name="**/sass/**"/>
			</fileset>
		</copy>
		
		<echo>Overwrite data with specs for ${hendi.project.app}</echo>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}" overwrite="yes">
			<fileset dir="data">
				<include name="*.*"/>
				<include name="catalogues/"/>
				<include name="modules/"/>
				<include name="resources/"/>
				<include name="templates/"/>
				<exclude name="resources/sass"/>
			</fileset>
		</copy>
		
		<echo>Copy libs to ${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/lib</echo>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/lib">
			<fileset dir="${wega.frontend_libs.dir}">
				<include name="**/*.js"/>
				<include name="**/*.css"/>
				<include name="**/*.gif"/>
				<include name="**/*.png"/>
				<include name="**/*.jpg"/>
				<include name="**/*.xsl"/>
				<include name="**/*.xml"/>
				<!-- exclude unnecessary directories -->
				<exclude name="bootstrap-vue/"/>
				<exclude name="bravura/"/>
				<exclude name="core-js/"/>
				<exclude name="@fortawesome/"/>
				<exclude name="prettydiff/"/>
				<exclude name="less/"/>
				<exclude name="sass/"/>
				<exclude name="lodash/"/>
				<exclude name="minify/"/>
				<exclude name="rx/"/>
				<exclude name="vnu/"/>
				<exclude name="vnu-jar/"/>
				<exclude name="vue/"/>
				<exclude name="yuicompressor/"/>
				<!-- exclude html files. non-well-formed html makes eXist choke -->
				<exclude name="**/*.html"/>
				<!-- exclude tests to reduce file size -->
				<exclude name="**/test/**"/>
				<exclude name="**/tests.js"/>
				<exclude name="**/docs/**"/>
				<exclude name="json-*/**"/>
			</fileset>
		</copy>
		
		<echo>Add icon.png</echo>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}" overwrite="yes" failonerror="no">
			<file file="hendi-secrets/wega-app/img/icon.png"/>
		</copy>
		<echo>Add image files to resources/img</echo>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/img/" overwrite="yes" failonerror="no">
			<fileset dir="hendi-secrets/wega-app/img/">
				<include name="*.png"/>
				<include name="*.jpg"/>
				<exclude name="icon.png"/>
			</fileset>
		</copy>
		<echo>Add favicons.</echo>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/favicons" overwrite="yes" failonerror="no">
			<fileset dir="hendi-secrets/wega-app/">
				<include name="favicon*.png"/>
			</fileset>
		</copy>
		<echo>Add fonts.</echo>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/fonts" failonerror="no">
			<fileset dir="hendi-secrets/wega-app/fonts" includes="**"/>
		</copy>
		<echo>Overwrite the WeGA-ODD with HenDi-ODD data</echo>
		<delete dir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/lib/WeGA-ODD"/>
		<mkdir dir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/lib/WeGA-ODD"/>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/lib/WeGA-ODD" overwrite="yes">
			<fileset dir="HenDi-ODD">
				<!--<include name="**/*.*"/>-->
				<include name="compiled-ODD/*.xml"/>
				<include name="src/**/*.xml"/>
			</fileset>
		</copy>
		<echo>Overwrite the WeGA Guidelines with the Henze-Digital Guidelines</echo>
		<delete dir="${WeGA-WebApp.basedir}/${wega.dist.dir}/guidelines"/>
		<mkdir dir="${WeGA-WebApp.basedir}/${wega.dist.dir}/guidelines"/>
		<copy todir="${WeGA-WebApp.basedir}/${wega.dist.dir}/guidelines" overwrite="yes">
			<fileset dir="HenDi-ODD/compiled-ODD">
				<include name="*.xml"/>
			</fileset>
		</copy>
	</target>
	
	<target name="minify" depends="webapp-wega-prepare-tasks, -set-properties">
		<echo>Run minify on CSS files</echo>
		<apply executable="${minify.path}" parallel="false">
			<fileset dir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/css" includes="*.css" excludes="*min.css"/>
			<redirector>
				<outputmapper type="glob" from="*.css" to="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/css/*-min.css"/>
			</redirector>
		</apply>
		<echo>Run minify on JS files</echo>
		<apply executable="${minify.path}" parallel="false">
			<fileset dir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/js" includes="*.js" excludes="*min.js"/>
			<redirector>
				<outputmapper type="glob" from="*.js" to="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/js/*-min.js"/>
			</redirector>
		</apply>
		<echo>Run minify on datepicker.js</echo>
		<apply executable="${minify.path}" parallel="false">
			<fileset dir="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/lib/jquery-ui/ui/widgets" includes="datepicker.js" excludes="*min.js"/>
			<redirector>
				<outputmapper type="glob" from="*.js" to="${WeGA-WebApp.basedir}/${wega.dist.dir}/resources/lib/jquery-ui/ui/widgets/*-min.js"/>
			</redirector>
		</apply>
	</target>
	
	<property name="project.xar.name" value="${hendi.project.app}-${hendi.project.version}"/>
	
	<target name="xar" depends="minify">
		<echo>Creating the xar Package (zipping).</echo>
		<zip destfile="webapp/${project.xar.name}.xar">
			<fileset dir="${WeGA-WebApp.basedir}/${wega.dist.dir}"/>
		</zip>
		
	</target>
	
	<target name="deploy" depends="clean, xar">
		<path id="classpath.eXist">
			<fileset dir="${hendi.exist.libs}" erroronmissingdir="yes">
				<include name="*.jar"/>
			</fileset>
		</path>
		<typedef resource="org/exist/ant/antlib.xml" uri="http://exist-db.org/ant">
			<classpath refid="classpath.eXist"/>
		</typedef>
		
		<!-- store xar-file in eXist-db -->
		<xdb:store xmlns:xdb="http://exist-db.org/ant"
			uri="${exist.db}/tmp"
			createcollection="true"
			createsubcollections="true"
			user="${exist.user}"
			password="${exist.pass}"
			failonerror="true">
			<fileset file="webapp/${project.xar.name}.xar"/>
		</xdb:store>
		
		<!-- Deploy the xar -->
		<xdb:xquery  xmlns:xdb="http://exist-db.org/ant"
			uri="${exist.db}"
			user="${exist.user}"
			password="${exist.pass}">
			(
			if("${project.name}" = repo:list()) then (
			repo:undeploy("${project.name}"),
			repo:remove("${project.name}")
			)
			else (),
			repo:install-and-deploy-from-db("/db/tmp/${project.xar.name}.xar")
			)
		</xdb:xquery>
	</target>
			
	</project>
	