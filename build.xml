<?xml version="1.0" encoding="UTF-8"?>
<project default="xar" name="HWH-WebApp" basedir="." xmlns:unless="ant:unless">
    
    <!-- import default properties from file -->
    <property file="local.build.properties" prefix="hwh"/>
    <property file="build.properties" prefix="hwh"/>
    <property file="${hwh.wega.repo}/local.build.properties"/>
    <property file="${hwh.wega.repo}/build.properties"/>
    
    <!-- Import build script for building WeGA-WebApp -->
    <import file="${hwh.wega.repo}/build.xml" as="wega" prefixseparator=":"/>
    
    <target name="clean-all">
        <antcall target="wega:clean"/>
        <antcall target="clean"/>
    </target>
    
    <target name="clean">
        <delete dir="${hwh.dist.dir}/"/>
        <delete dir="${hwh.dist.tmp.dir}/"/>
    </target>
    
    <!-- build WeGA-WebApp and get package and unzip it to local dist dir -->
    <target name="build-wega-pkg">
        <ant antfile="build.xml" dir="${hwh.wega.repo}/"/>
        <unzip src="${hwh.wega.repo}/build/WeGA-WebApp-4.4.0.xar" dest="dist"/>
    </target>
    
    <!-- build hwh-webapp -->
    <target name="build-hwh-specs">
        
        <!-- create expath-pkg.xml -->
        <copy file="data/expath-pkg.xml.tmpl" tofile="${hwh.dist.tmp.dir}/expath-pkg.xml" filtering="true" overwrite="true">
            <filterset>
                <filter token="project.app" value="${hwh.project.app}"/>
                <filter token="project.name" value="${hwh.project.name}"/>
                <filter token="project.version" value="${hwh.project.version}"/>
            </filterset>
        </copy>
        
        <!-- create repo.xml -->
        <copy file="data/repo.xml.tmpl" tofile="${hwh.dist.tmp.dir}/repo.xml" filtering="true" overwrite="true">
            <filterset>
                <filter token="project.app" value="${hwh.project.app}"/>
                <filter token="project.author" value="${hwh.project.author}"/>
                <filter token="project.name" value="${hwh.project.name}"/>
            </filterset>
        </copy>
        
        <!-- get sass data from wega -->
        <copy todir="${hwh.dist.tmp.dir}/resources/sass/">
            <fileset dir="${hwh.wega.repo}/resources/sass/">
                <include name="**/*.*"/>
            </fileset>
        </copy>
        
        <!-- get sass data from hwh -->
        <copy todir="${hwh.dist.tmp.dir}/resources/sass/" overwrite="yes">
           <fileset dir="data/resources/sass/">
               <include name="**/*.*"/>
           </fileset>
        </copy>
        
        <echo>Create CSS files via sass</echo>
        <copy todir="${hwh.dist.tmp.dir}/" overwrite="yes">
            <fileset dir="${hwh.wega.repo}/">
                <include name="node_modules/bootstrap/**"/>
                <include name="node_modules/font-awesome/**"/>
            </fileset>
        </copy>
        <exec executable="${hwh.wega.repo}/${dev_libs.dir}/sass/sass.js">
            <arg line="${hwh.dist.tmp.dir}/resources/sass/main.scss ${hwh.dist.tmp.dir}/resources/css/styles.css"/>
        </exec>
        
        <echo>Run minify on CSS files</echo>
        <apply executable="${hwh.wega.repo}/${dev_libs.dir}/minify/bin/minify.js" parallel="false">
            <fileset dir="${hwh.dist.tmp.dir}/resources/css" includes="*.css" excludes="*min.css"/>
            <redirector>
                <outputmapper type="glob" from="*.css" to="${hwh.dist.tmp.dir}/resources/css/*-min.css"/>
            </redirector>
        </apply>
        
    </target>
    
    <!-- override WeGA-WebApp with hwh-webapp -->
    <target name="update-dist" depends="build-wega-pkg, build-hwh-specs">
        <copy todir="${hwh.dist.dir}/" overwrite="yes">
            <fileset dir="data/">
                <include name="catalogues/"/>
                <include name="resources/favicons/"/>
                <include name="templates/"/>
                <exclude name="*.tmpl"/>
            </fileset>
        </copy>
        
        <copy todir="dist" overwrite="yes">
            <fileset dir="dist-tmp">
                <include name="*.*"/>
                <include name="catalogues/"/>
                <include name="resources/"/>
                <include name="templates/"/>
                <exclude name="node_modules/"/>
            </fileset>
            <file file="${hwh.secrets.repo}/img/icon.png"/>
        </copy>
        <copy todir="${hwh.dist.dir}/resources/img/">
            <fileset dir="${hwh.secrets.repo}/img/">
                <include name="*.png"/>
                <include name="*.jpg"/>
                <exclude name="icon.png"/>
            </fileset>
        </copy>
        <copy todir="${hwh.dist.dir}/resources/favicons" overwrite="yes">
            <fileset dir="${hwh.secrets.repo}/">
                <include name="favicon*.png"/>
            </fileset>
        </copy>
    </target>
    
    <!-- make package -->
    <target name="xar" depends="update-dist">
       <zip destfile="build/${hwh.project.app}-${hwh.project.version}.xar">
           <fileset dir="dist"/>
       </zip>
    </target>
    
    <target name="deploy" depends="clean-all, xar">
        <path id="classpath.eXist5">
            <fileset dir="${hwh.exist5.libs}" erroronmissingdir="no">
                <include name="*.jar"/>
            </fileset>
        </path>
        <typedef resource="org/exist/ant/antlib.xml" uri="http://exist-db.org/ant">
            <classpath refid="classpath.eXist5"/>
        </typedef>
        
        <!-- store xar-file in eXist-db -->
        <xdb:store xmlns:xdb="http://exist-db.org/ant"
            uri="${hwh.exist.db}/tmp"
            createcollection="true"
            createsubcollections="true"
            user="${hwh.exist.user}"
            password="${hwh.exist.pass}"
            failonerror="true">
            <fileset file="${hwh.build.dir}/${hwh.project.app}-${hwh.project.version}.xar"/>
        </xdb:store>
        
        <!-- Deploy the xar -->
        <xdb:xquery  xmlns:xdb="http://exist-db.org/ant"
            uri="${hwh.exist.db}"
            user="${hwh.exist.user}"
            password="${hwh.exist.pass}">
            (
            if("${hwh.project.name}" = repo:list()) then (
            repo:undeploy("${hwh.project.name}"),
            repo:remove("${hwh.project.name}")
            )
            else (),
            repo:install-and-deploy-from-db("/db/tmp/${hwh.project.app}-${hwh.project.version}.xar")
            )
        </xdb:xquery>
    </target>
</project>
