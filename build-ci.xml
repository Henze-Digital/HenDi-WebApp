<?xml version="1.0" encoding="UTF-8"?>
<project default="xar" name="HWH-WebApp-ci" basedir="." xmlns:unless="ant:unless">

    <dirname property="HWH-WebApp-ci.basedir" file="${ant.file.HWH-WebApp-ci}"/>

    <!-- import default properties from file -->
    <property file="${HWH-WebApp-ci.basedir}/build.properties" prefix="hwh"/>

    <!-- ToDo: -->
	<!-- clone wega source code, modify and build it. -->

	<target name="initiate">
		<echo>Initiating task. Creating temp and dist dirs.</echo>
        <mkdir dir="${hwh.clones.dir}"/>
		<mkdir dir="${hwh.build.dir}"/>
        <mkdir dir="${hwh.build.tmp.dir}"/>
    </target>

    <target name="clone-wega-webapp-repo">
        <exec executable="git" dir="${hwh.clones.dir}" failonerror="true">
        	<arg line="clone https://github.com/Henze-Digital/WeGA-WebApp.git ${hwh.clones.dir}/WeGA-WebApp" />
        </exec>
    </target>
    <target name="clone-hendi-odd">
        <exec executable="git" dir="${hwh.clones.dir}" failonerror="true">
            <!--<arg line="clone https://github.com/Henze-Digital/HWH-ODD.git HWH-ODD" />-->
        	<arg line="clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.uni-paderborn.de/vife/henze-digital/HenDi-ODD.git ${hwh.clones.dir}/HenDi-ODD"/>
        </exec>
    </target>
    <target name="clone-hwh-secrets">
        <exec executable="git" dir="${hwh.clones.dir}" failonerror="true">
        	<arg line="clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.uni-paderborn.de/vife/henze-digital/hwh-data-internal-only.git ${hwh.clones.dir}/hwh-data-internal-only"/>
        </exec>
    </target>

    <target name="init">
<!--        <antcall target="ci:clean"/>-->
    	<antcall target="ci:initiate"/>
        <antcall target="ci:clone-wega-webapp-repo"/>
        <antcall target="ci:clone-hendi-odd"/>
        <antcall target="ci:clone-hwh-secrets"/>
    </target>

    <!--<target name="build-wega-xar" depends="init">
        <echo>Building the WeGA-WebApp.xar</echo>
        <echo>Executing ant xar at WeGA-WebApp repo (build.xml) </echo>
        <ant antfile="build.xml" dir="temp/WeGA-WebApp/" target="xar"/>
        <echo>Finished build of WeGA-WebApp. Build successful.</echo>
    </target>-->

    <target name="get-wega-xar-data" depends="init">
        <echo>Set properties for WeGA-WebApp build.xml</echo>
        <!-- Attention: property has to be included in the same target where it is used! -->
        <property file="${hwh.clones.dir}/WeGA-WebApp/build.properties" prefix="wega"/>
        <echo>Get the WeGA-WebApp.xar (unzip to build dir).</echo>
        <mkdir dir="${hwh.clones.dir}/WeGA-WebApp/${wega.build.dir}/"/>
    	<mkdir dir="${hwh.clones.dir}/WeGA-WebApp/package/"/>
        <get src="https://github.com/Edirom/WeGA-WebApp/releases/download/v${hwh.wega.project.version}/${wega.project.app}-${hwh.wega.project.version}.xar" dest="${hwh.clones.dir}/WeGA-WebApp/package/${wega.project.app}-${hwh.wega.project.version}.xar"/>
    	<unzip src="${hwh.clones.dir}/WeGA-WebApp/package/${wega.project.app}-${hwh.wega.project.version}.xar" dest="${hwh.clones.dir}/WeGA-WebApp/${wega.build.dir}"/>
    </target>

    <target name="prepare-hwh-specs" depends="init">
        <echo>Prepare the WebApp-specs for Henze-Digital.</echo>
        <antcall target="ci:prepare-package-files"/>
        <antcall target="ci:prepare-css"/>
        <antcall target="ci:prepare-hendi-odd"/>
    </target>

    <target name="prepare-package-files">
        <echo>Create expath-pkg.xml</echo>
        <copy file="data/expath-pkg.xml.tmpl" tofile="${hwh.build.tmp.dir}/expath-pkg.xml" filtering="true" overwrite="true">
            <filterset>
                <filter token="project.app" value="${hwh.project.app}"/>
                <filter token="project.name" value="${hwh.project.name}"/>
                <filter token="project.version" value="${hwh.project.version}"/>
            </filterset>
        </copy>
        <echo>Create repo.xml</echo>
        <copy file="data/repo.xml.tmpl" tofile="${hwh.build.tmp.dir}/repo.xml" filtering="true" overwrite="true">
            <filterset>
                <filter token="project.app" value="${hwh.project.app}"/>
                <filter token="project.author" value="${hwh.project.author}"/>
                <filter token="project.name" value="${hwh.project.name}"/>
            </filterset>
        </copy>
    </target>

    <target name="prepare-css">
        <echo>Get sass data from WeGA</echo>
        <copy todir="${hwh.build.tmp.dir}/resources/sass/">
            <fileset dir="${hwh.clones.dir}/WeGA-WebApp/resources/sass/">
                <include name="**/*.*"/>
            </fileset>
        </copy>
        <echo>Get sass data from Henze-Digital</echo>
        <copy todir="${hwh.build.tmp.dir}/resources/sass/" overwrite="yes">
            <fileset dir="data/resources/sass/">
                <include name="**/*.*"/>
            </fileset>
        </copy>
    	<echo>Add node_module from WeGA</echo>
        <copy todir="${hwh.build.tmp.dir}/" overwrite="yes">
        	<dirset dir="${hwh.clones.dir}/WeGA-WebApp/">
                <include name="node_modules/bootstrap"/>
                <include name="node_modules/font-awesome"/>
        	</dirset>
        </copy>
        <echo>Create CSS files via sass</echo>
        <exec executable="${sass.path}">
        	<arg line="${hwh.build.tmp.dir}/resources/sass/main.scss ${hwh.build.tmp.dir}/resources/css/styles.css"/>
        </exec>
        <echo>Run minify on CSS files</echo>
        <apply executable="${minify.path}" parallel="false">
            <fileset dir="${hwh.build.tmp.dir}/resources/css" includes="*.css" excludes="*min.css"/>
            <redirector>
                <outputmapper type="glob" from="*.css" to="${hwh.build.tmp.dir}/resources/css/*-min.css"/>
            </redirector>
        </apply>
    </target>

    <target name="prepare-hendi-odd">
    	<echo>Get HenDi-ODD data</echo>
    	<copy todir="${hwh.build.tmp.dir}/HenDi-ODD">
    		<fileset dir="${hwh.clones.dir}/HenDi-ODD">
                <include name="compiled-ODD/*.xml"/>
                <include name="src/**/*.xml"/>
            </fileset>
        </copy>
    </target>

    <target name="update-dist" depends="get-wega-xar-data, prepare-hwh-specs">
        <echo>Override the unzipped WeGA-WebApp data with hwh-webapp specs</echo>
    	<echo>Copy hwh-spec data to ${hwh.build.dir}.</echo>
        <copy todir="${hwh.build.dir}/" overwrite="yes">
            <fileset dir="data/">
            	<include name="**/*.*"/>
                <!--<include name="catalogues/"/>
                <include name="resources/favicons/"/>
                <include name="templates/"/>
                <include name="controller.xql"/>
                <include name="README.md"/>
                <include name="LICENSE"/>-->
                <exclude name="*.tmpl"/>
            </fileset>
        </copy>
    	<echo>Copy processed hwh-spec data to ${hwh.build.dir}</echo>
        <copy todir="${hwh.build.dir}" overwrite="yes">
            <fileset dir="${hwh.build.tmp.dir}">
                <include name="*.*"/>
                <include name="resources/"/>
                <include name="templates/"/>
                <exclude name="node_modules/"/>
            </fileset>
        </copy>
        <echo>Add icon.png</echo>
        <copy todir="${hwh.build.dir}" overwrite="yes">
            <file file="${hwh.clones.dir}/hwh-data-internal-only/wega-app/img/icon.png"/>
        </copy>
        <echo>Add image files to resources/img</echo>
        <copy todir="${hwh.build.dir}/resources/img/" overwrite="yes">
            <fileset dir="${hwh.clones.dir}/hwh-data-internal-only/wega-app/img/">
                <include name="*.png"/>
                <include name="*.jpg"/>
                <exclude name="icon.png"/>
            </fileset>
        </copy>
        <echo>Add favicons.</echo>
        <copy todir="${hwh.build.dir}/resources/favicons" overwrite="yes">
            <fileset dir="${hwh.clones.dir}/hwh-data-internal-only/wega-app/">
                <include name="favicon*.png"/>
            </fileset>
        </copy>
        <echo>Add fonts.</echo>
        <copy todir="${hwh.build.dir}/resources/fonts" failonerror="false">
            <fileset dir="${hwh.clones.dir}/hwh-data-internal-only/wega-app/fonts">
                <include name="*.*"/>
            </fileset>
        </copy>

    	<echo>Override the WeGA-ODD with HenDi-ODD data</echo>
    	<delete dir="${hwh.build.dir}/resources/lib/WeGA-ODD"/>
    	<mkdir dir="${hwh.build.dir}/resources/lib/WeGA-ODD"/>
        <copy todir="${hwh.build.dir}/resources/lib/WeGA-ODD" overwrite="yes">
        	<fileset dir="${hwh.build.tmp.dir}/HenDi-ODD">
                <include name="**/*.*"/>
            </fileset>
        </copy>
        <echo>Override the WeGA Guidelines with the Henze-Digital Guidelines</echo>
    	<delete dir="${hwh.build.dir}/guidelines"/>
    	<mkdir dir="${hwh.build.dir}/guidelines"/>
        <copy todir="${hwh.build.dir}/guidelines">
        	<fileset dir="${hwh.build.tmp.dir}/HenDi-ODD/compiled-ODD">
                <include name="*.xml"/>
            </fileset>
        </copy>
    </target>

    <target name="xar" depends="update-dist">
        <echo>Creating the xar Package (zipping).</echo>
    	<zip destfile="${hwh.dist.dir}/${hwh.project.app}-${hwh.project.version}.xar">
            <fileset dir="${hwh.build.dir}"/>
        </zip>
    </target>
</project>
